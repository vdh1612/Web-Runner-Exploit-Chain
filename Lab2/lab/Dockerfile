FROM php:8.0-apache

# Update and install necessary packages. 
# The a2enmod headers command enables the headers module in Apache.
RUN apt-get update && apt-get install -y \
    net-tools \
    python3 \
    libzip-dev \
    && a2enmod headers 

RUN docker-php-ext-configure zip && docker-php-ext-install zip
RUN docker-php-ext-install mysqli && docker-php-ext-enable mysqli zip

WORKDIR /var/www/html/

# Copy the Apache configuration files to the server
COPY ./src/configs/apache2.conf /etc/apache2/apache2.conf
COPY ./src/configs/000-default.conf /etc/apache2/sites-available/000-default.conf

COPY ./src .

# Changes ownership of the files to root and the group to www-data.
RUN chown -R root:www-data /var/www/html

# set appopriate permissions for the files and directories
RUN chmod 750 /var/www/html
RUN find . -type f -exec chmod 640 {} \;
RUN find . -type d -exec chmod 750 {} \;

# Add write permissions for the group
RUN chmod g+w /var/www/html/upload/
RUN chmod g+w /var/www/html/admin/cv/
RUN chmod +t -R /var/www/html/

# Set the root password using the SHA512 hashing method
RUN echo 'root:passwd_4_root' | chpasswd --crypt-method SHA512

# Add 3rd flag to the /etc/passwd file
RUN echo "Bounty_boys{3rd_flag}" >> /etc/passwd

# Make the /etc/shadow file readable by others
RUN chmod o+r /etc/shadow

# Add a final flag to a hidden file
RUN echo "Bounty_boys{final_flag}" >> /root/flag2.txt
