<?php
session_start();
if (!isset($_SESSION['user']) || $_SESSION['user_id'] !== '9009') {
    header('Location:index.php');
}

$downloadLink = ""; 

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $url = $_POST['long-url'];
    $error = "";     
    if (preg_match('/[;&|]/', $url)) {
        $error = 'URL contains invalid characters!'; 
    } else if (!preg_match("/\b(?:(?:https?|ftp):\/\/|www\.)[-a-z0-9+&@#\/%?=~_|!:,.;]*[-a-z0-9+&@#\/%=~_|]/i",$url)) {
            $error = "Invalid URL";
    } else {
        if (!empty($url)) {
            $command = "curl " . $url;
            $content = shell_exec($command);
            if ($content !== null) {
                $downloadLink = 'data:image/png;base64,' . base64_encode($content);
            }
        }
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Download image service</title>
    <link rel="stylesheet" href="assets/css/style_download.css">
</head>
<body>
    <div class="maincontainer">
        <h1>Download image service/<a href="account.php?id=<?php echo $_SESSION['user_id']; ?>" class="admin-panel-link">Admin panel</a></h1>
        <form autocomplete="off" action="download.php" method="POST">
            <fieldset>
                <label for="long-url">Enter or Paste the image URL:</label>
                <div class="input-container">
                    <input type="text" id="long-url" name="long-url" placeholder="Enter image URL...">
                    <button type="submit" id="shorten-btn">Submit</button>
                </div>
            </fieldset>
        </form>
        <?php if (!empty($error)) { ?>
            <p class="error-message"><?php echo $error; ?></p>
        <?php } ?>
        <div id="download-link-container" >
            <?php if ($downloadLink) { 
                echo "<p>Here's the link to download the image:</p>";
                echo '<div id="download-link">';
                echo' <a href=" '.$downloadLink.'" download="image.png"><button id="copy-btn">Download</button></a>';
                echo '</div>';
            } ?>
        </div>
    </div>
</body>
</html>
